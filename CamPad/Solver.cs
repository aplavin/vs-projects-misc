using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Drawing;

namespace CamPad
{
    public class Solver
    {
        double[,] p;

        public Solver(double[] x, double[] y)
        {
            p = new double[4, 4];
            p[1, 1] = (x[0] * (x[3] * (-y[1] + y[2]) + x[2] * (y[1] - y[3])) + x[1] * (x[3] * (y[0] - y[2]) + x[2] * (-y[0] + y[3]))) / (x[3] * (y[1] - y[2]) + x[1] * (y[2] - y[3]) + x[2] * (-y[1] + y[3]));
            p[1, 2] = -x[0] + (x[3] * (x[2] * (y[0] - y[1]) + x[0] * (y[1] - y[2]) + x[1] * (-y[0] + y[2]))) / (x[3] * (y[1] - y[2]) + x[1] * (y[2] - y[3]) + x[2] * (-y[1] + y[3]));
            p[1, 3] = x[0];
            p[2, 1] = (x[3] * (y[0] - y[1]) * y[2] + x[0] * y[1] * y[2] - x[2] * y[0] * y[3] - x[0] * y[1] * y[3] + x[2] * y[1] * y[3] + x[1] * y[0] * (-y[2] + y[3])) / (x[3] * (y[1] - y[2]) + x[1] * (y[2] - y[3]) + x[2] * (-y[1] + y[3]));
            p[2, 2] = (-x[1] * y[0] * y[2] + x[3] * y[0] * (-y[1] + y[2]) + x[2] * y[1] * (y[0] - y[3]) + x[0] * y[1] * y[3] - x[0] * y[2] * y[3] + x[1] * y[2] * y[3]) / (x[3] * (y[1] - y[2]) + x[1] * (y[2] - y[3]) + x[2] * (-y[1] + y[3]));
            p[2, 3] = y[0];
            p[3, 1] = (-(x[2] - x[3]) * (y[0] - y[1]) + (x[0] - x[1]) * (y[2] - y[3])) / (x[3] * (y[1] - y[2]) + x[1] * (y[2] - y[3]) + x[2] * (-y[1] + y[3]));
            p[3, 2] = -1 + (x[1] * y[0] - x[2] * y[0] - x[0] * y[1] + x[2] * y[1] + x[0] * y[2] - x[1] * y[2]) / (x[2] * y[1] - x[3] * y[1] - x[1] * y[2] + x[3] * y[2] + x[1] * y[3] - x[2] * y[3]);
            p[3, 3] = 1;
        }

        public Point FromCam(Point po)
        {
            return new Point(
                (int)(1368 * (-((-p[1, 3] * p[2, 2] + p[1, 2] * p[2, 3] - p[2, 3] * p[3, 2] * po.X + p[2, 2] * p[3, 3] * po.X + p[1, 3] * p[3, 2] * po.Y - p[1, 2] * p[3, 3] * po.Y) / (p[1, 2] * p[2, 1] - p[1, 1] * p[2, 2] + p[2, 2] * p[3, 1] * po.X - p[2, 1] * p[3, 2] * po.X - p[1, 2] * p[3, 1] * po.Y + p[1, 1] * p[3, 2] * po.Y))))
                ,
               (int)(768 * (1 + ((-p[1, 3] * p[2, 1] + p[1, 1] * p[2, 3] - p[2, 3] * p[3, 1] * po.X + p[2, 1] * p[3, 3] * po.X + p[1, 3] * p[3, 1] * po.Y - p[1, 1] * p[3, 3] * po.Y) / (-p[1, 2] * p[2, 1] + p[1, 1] * p[2, 2] - p[2, 2] * p[3, 1] * po.X + p[2, 1] * p[3, 2] * po.X + p[1, 2] * p[3, 1] * po.Y - p[1, 1] * p[3, 2] * po.Y))))
                );
        }
    }
}
